---
title: 微信小程序获取天气数据并展示
date: 2024-11-09 00:34:00
tags: 
---

我在微信小程序实现了获取当前定位和天气，并且给出相应的穿衣指南，效果图如下。

![小程序页面](小程序页面.png)


我参考的是[微信小程序 搞一个天气api_为了保证天气服务的稳定性,后期计划同时支持三套天气数据源,将天气 api 封装成一-CSDN博客](https://blog.csdn.net/zhihu_0/article/details/116159227)，下面是我自己实现的过程。之所以没有用api，是因为大部分教程使用的“和风天气api”，这个接口已经停止提供服务了。经过不断搜寻，我发现这篇文章可以直接从“腾讯天气”网页上爬取数据下来。这样一来，可以获取很多数据还不用注册账户或交钱给api。

##### 抓包
进入[腾讯天气](https://tianqi.qq.com/index.htm)后，打开网页开发者模式，快捷键**F12**（笔记本电脑尝试**fn+F12**）。
发现这个api需要一些参数，**来源，天气状态，省份和城市**，因为我们要获取动态的获取天气的话，省份和城市是肯定不能写死的。
![抓包展示](抓包展示.png)
同时我发现返回的天气状态包括很多内容，**forecast_1h ,forecast_24h , index , alarm , limit , tips , rise** 根据名称便可以知道代表什么数据。如果不清楚可以点击预览查看这些数据的详细信息，并选择自己所需要的。
![详细信息](详细信息.png)
进一步查看请求包发现了一个这样的请求，可以通过ip地址来获取天气。
![ip获取](ip获取.png)

##### 渲染到微信小程序中
至此获取了两个api，
一个是通过发送http请求的ip地址来获取省份城市
https://apis.map.qq.com/ws/location/v1/ip?key=3BFBZ-ZKD3X-LW54A-ZT76D-E7AHO-4RBD5
还有一个是通过省份城市来获取天气
https://wis.qq.com/weather/common?source=pc&weather_type=observe%7Cforecast_24h&province=省份&city=你的城市

这里我对两个api进行了一些处理，我只返回了我需要的。

```javascript
//通过当前的ip地址获取城市，来自腾讯的api

    getCity(){
      var that = this
      let url = 'https://r.inews.qq.com/api/ip2city?otype=jsonp&callback=jQuery111309180753781859947_1728908642841&_=1728908642842'
      wx.request({
        method:'get',
        url: url,  
        success(res){
          // 假设 res 是包含回调函数的 JSONP 数据
      let jsonDataStr = res.data;
      // 通过正则表达式去掉回调函数包装部分
      let jsonStr = jsonDataStr.replace(/^jQuery\d+_\d+\(|\)$/g, '');
      // 将字符串转换为 JSON 对象
      let jsonData = JSON.parse(jsonStr);
      // 现在可以正常访问 province 等属性
      let p = jsonData.province;
      console.log(p);  // 输出 "广东省"
          console.log(p);
          if(res.statusCode===200){
            that.setData({
              city:jsonData.city,
              province: jsonData.province,
            })
          }
        }
      })
    }
```

```javascript
//获取天气的API

    getWether(){
      let that = this
      let url = `https://wis.qq.com/weather/common?source=pc&weather_type=observe%7Cforecast_24h%7Cindex&province=${that.data.province}&city=${that.data.city}`
      wx.request({
        url: url,
        method:'GET',
        success(res){
          let todayWether = res.data.data.observe;
          let todayClothes = res.data.data.index.clothes;
          console.log(res.data);
          console.log(todayWether);
          console.log(todayClothes);
          if(res.statusCode===200){
              that.setData({
                weather:`${todayWether.degree}°  ${todayWether.weather_short} ${todayWether.wind_direction_name}${todayWether.wind_power}级`,
                clothes:`${todayClothes.detail}`
              })
          }
        }
      })
    }
```
因为需要先知道省份和城市，才能通过省份和城市获取相应信息。所以，我们需要先执行获取省份和城市的方法！我使用了setTime()这个方法，让获取天气的时候慢200ms从而达到我们想要的效果。

```javascript
 /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.getCity()
    //获取天气的时候慢200ms
    setTimeout(()=>{
      this.getWether()
    },500)
  }
```

##### 渲染到页面
这个页面(wxml)因人而异，只需要将在js设置的变量用{% raw %}{{ {{}} }}{% endraw %}
括起来就好了。我的代码如下：

```html
<view>
<text >现在属于</text>
•{{city}} {{weather}}
{{clothes}}
{{season}}
{{tips}}
</view>
```



