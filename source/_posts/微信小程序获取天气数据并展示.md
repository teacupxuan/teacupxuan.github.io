---
title: 微信小程序获取天气数据并展示
date: 2024-11-09 00:34:00
tags: 
  - 微信小程序
  - JavaScript
  - API
  - 前端开发
categories: 
  - 技术分享
description: 通过腾讯天气API实现微信小程序天气查询功能，包含定位获取、天气数据展示和穿衣指南推荐
---

## 📱 项目简介

在这个项目中，我实现了一个微信小程序的天气查询功能，主要包括：

- 🌍 **自动定位** - 获取用户当前位置
- 🌤️ **天气查询** - 实时天气数据展示  
- 👔 **穿衣指南** - 根据天气推荐穿衣建议

## 🎯 效果展示

<div align="center">
  <img src="小程序页面.png" alt="小程序页面效果" style="max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
  <p><em>微信小程序天气页面效果图</em></p>
</div>

## 💡 技术方案选择

### 为什么不用传统API？

在开发过程中，我发现大部分教程使用的**"和风天气API"**已经停止免费服务。经过调研，我选择了一个更优的解决方案：

> 💰 **免费且稳定** - 直接从腾讯天气获取数据  
> 📊 **数据丰富** - 包含多种天气指标  
> 🚀 **无需注册** - 不需要申请API密钥

**参考文章**：[微信小程序天气API实现方案](https://blog.csdn.net/zhihu_0/article/details/116159227)

---

## 🔍 API分析与抓包

### Step 1: 网络抓包分析

首先进入 [腾讯天气官网](https://tianqi.qq.com/index.htm)，打开开发者工具进行抓包分析：

1. **打开开发者模式**：按 `F12`（笔记本尝试 `Fn+F12`）
2. **分析请求参数**：发现API需要以下参数
   - `source` - 数据来源
   - `weather_type` - 天气状态类型
   - `province` - 省份信息
   - `city` - 城市信息

<div align="center">
  <img src="抓包展示.png" alt="抓包分析" style="max-width: 600px; border-radius: 8px; margin: 10px 0;">
  <p><em>网络请求抓包分析</em></p>
</div>

### Step 2: 数据结构分析

通过分析返回数据，发现包含丰富的天气信息：

- `forecast_1h` - 1小时预报
- `forecast_24h` - 24小时预报  
- `index` - 生活指数（包含穿衣指南）
- `alarm` - 天气预警
- `tips` - 生活提示

<div align="center">
  <img src="详细信息.png" alt="数据详情" style="max-width: 600px; border-radius: 8px; margin: 10px 0;">
  <p><em>API返回数据详细信息</em></p>
</div>

### Step 3: IP定位API发现

进一步分析发现了通过IP获取地理位置的API：

<div align="center">
  <img src="ip获取.png" alt="IP定位" style="max-width: 600px; border-radius: 8px; margin: 10px 0;">
  <p><em>通过IP地址获取地理位置</em></p>
</div>

---

## 🛠️ 核心代码实现

### 📍 获取用户位置

通过IP地址自动获取用户所在城市：

```javascript
/**
 * 通过IP地址获取用户当前城市
 * 使用腾讯地图API实现自动定位
 */
getCity() {
  const that = this;
  const url = 'https://r.inews.qq.com/api/ip2city?otype=jsonp&callback=jQuery111309180753781859947_1728908642841&_=1728908642842';
  
  wx.request({
    method: 'GET',
    url: url,
    success(res) {
      try {
        // 处理JSONP格式数据
        let jsonDataStr = res.data;
        // 使用正则表达式去掉回调函数包装
        let jsonStr = jsonDataStr.replace(/^jQuery\d+_\d+\(|\)$/g, '');
        // 转换为JSON对象
        let jsonData = JSON.parse(jsonStr);
        
        console.log('获取到的位置信息:', jsonData);
        
        if (res.statusCode === 200) {
          that.setData({
            city: jsonData.city,
            province: jsonData.province,
          });
        }
      } catch (error) {
        console.error('解析位置数据失败:', error);
      }
    },
    fail(error) {
      console.error('获取位置失败:', error);
    }
  });
}
```

### 🌤️ 获取天气数据

基于位置信息获取详细天气数据：

```javascript
/**
 * 获取天气信息
 * 根据省份和城市获取实时天气和生活指数
 */
getWeather() {
  const that = this;
  const url = `https://wis.qq.com/weather/common?source=pc&weather_type=observe%7Cforecast_24h%7Cindex&province=${that.data.province}&city=${that.data.city}`;
  
  wx.request({
    url: url,
    method: 'GET',
    success(res) {
      try {
        const todayWeather = res.data.data.observe;
        const todayClothes = res.data.data.index.clothes;
        
        console.log('天气数据:', res.data);
        console.log('今日天气:', todayWeather);
        console.log('穿衣指南:', todayClothes);
        
        if (res.statusCode === 200) {
          that.setData({
            weather: `${todayWeather.degree}°  ${todayWeather.weather_short} ${todayWeather.wind_direction_name}${todayWeather.wind_power}级`,
            clothes: `${todayClothes.detail}`
          });
        }
      } catch (error) {
        console.error('解析天气数据失败:', error);
      }
    },
    fail(error) {
      console.error('获取天气失败:', error);
    }
  });
}
```

### ⏰ 页面生命周期

合理安排API调用顺序，确保数据获取的时序性：

```javascript
/**
 * 页面加载时的初始化逻辑
 * 先获取位置，再获取天气（异步处理）
 */
onLoad: function (options) {
  // 首先获取用户位置
  this.getCity();
  
  // 延迟获取天气数据，确保位置信息已获取
  setTimeout(() => {
    this.getWeather();
  }, 500);
}
```

---

## 🎨 页面渲染

### WXML模板

简洁的页面结构，展示核心天气信息：

```html
<view class="weather-container">
  <text class="location-text">现在属于</text>
  <view class="weather-info">
    <text class="city">{{city}}</text>
    <text class="weather">{{weather}}</text>
  </view>
  <view class="clothes-guide">
    <text class="clothes">{{clothes}}</text>
  </view>
  <view class="additional-info">
    <text class="season">{{season}}</text>
    <text class="tips">{{tips}}</text>
  </view>
</view>
```

---

## 📚 总结与收获

### ✅ 项目亮点

1. **免费方案** - 无需付费API，降低开发成本
2. **自动定位** - 用户体验友好，无需手动输入
3. **数据丰富** - 不仅有天气，还有生活指数
4. **代码简洁** - 逻辑清晰，易于维护

### 🔧 技术要点

- **异步处理** - 合理安排API调用顺序
- **错误处理** - 完善的异常捕获机制  
- **数据解析** - JSONP格式数据的正确处理
- **用户体验** - 加载状态和错误提示

### 🚀 后续优化

- [ ] 添加加载动画
- [ ] 支持手动切换城市
- [ ] 增加7天天气预报
- [ ] 优化页面样式设计

---

*希望这个教程对你有帮助！如果有任何问题，欢迎在评论区交流讨论。* 🌟
