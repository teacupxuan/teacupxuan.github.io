---
title: 后端定时任务 & xxl-job
date: 2025-8-17 17:16:31
tags:
  - 后端定时任务
categories:
  - 技术分享
description: 后端定时任务学习笔记
---

最近在实习过程中，需要写定时任务。我之前在网上学习“苍穹外卖”的时候，写过定时任务。
具体功能主要包括：
- 每分钟检查支付超时的订单，并将其状态修改为“已取消”。
- 每天凌晨检查“派送中”的订单，并将其状态修改为“已完成”。

当时只是跟着视频敲代码，并没有更多自己的理解和思考。比如项目到底是如何触发定时任务的？定时任务为什么会自动开始运行？以及没有到达对应的时间，要如何对这个定时任务进行测试？如何对多个定时项目的多个定时任务进行统一管理？企业中都如何写定时任务？

正好现在遇到了这个问题，就对这个知识点做一个总结吧！

### 定时任务是什么？

##### 生活类比：
想象家里有一个智能闹钟（定时任务），可以让它：
- 每天早上7点叫你起床
- 每隔30分钟提醒你喝水

你只需要提前**设定好时间和任务内容**，它就会自动执行，不用你手动去按按钮。

##### 在后端系统中：
- 这个“闹钟”就是**定时任务调度器**（Scheduler）
- 你在代码里告诉它：**什么时候执行**（时间表达式，比如CRON表达式）、**要执行什么逻辑**
- 它就会到点执行，比如：
	- 每天0点清理过期数据
	- 每小时计算一次统计报表
	- 每5分钟同步一次缓存


### 为什么它会自动运行？

这个“自动”不是凭空发生的，而是**程序里有个“永远在跑的循环”** 在帮你看表（任务列表）。

- 当你的后端程序启动时，如果你集成了定时任务框架（Quartz、xxl-job、Spring Scheduler等），它会：
	1. 启动一个**常驻线程** （就像24小时值班的秘书）
	2. 读取所有任务的“执行时间表”
	3. 不停地检查：有没有到时间要执行的任务？
	4. 一到时间，就帮你调用你写好的那段逻辑函数

所以：
- 你感觉它是“自动运行”
- 实际上是因为**程序启动时已经注册了一个定时器线程**，它一直在后台看表、按表执行


### xxl-job到底是干嘛的？

可以把它看作是 **“企业级的任务调度中心”**，作用就像是：
- 你公司有很多部门（很多服务/机器）
- 每个部门都有各种任务（脚本、计算、同步等）
- 如果每个部门都自己定闹钟，容易乱、不好统一管理
- 所以公司有个**统一调度室**（xxl-job-admin）
	- 统一存储所有任务的执行时间、状态
	- 到点了就通知具体的员工（xxl-job-executor）去干活

##### xxl-job运行原理（简化版）：
1. **xxl-job-admin**（调度中心）
	- 存在一张“任务表”，里面有任务的 CRON 表达式、状态等
	- 有个定时扫描器（调度线程），负责按时间触发任务
	- 到点了，就发 HTTP 请求给对应的执行器
2. **xxl-job-executor**（执行器）
	 - 跑在你服务的 JVM 里
	 - 收到调度中心的 HTTP 请求，就执行你写好的业务逻辑（JobHandler）
	 - 执行结果再回传给调度中心

所以它自动运行的原因是：
- 你的执行器进程一直在运行（跟服务一起启动）
- 调度中心会按设定的时间发任务请求
- 执行器接到后自动调用你的任务代码

### 定时任务如何进行测试？

企业里的测试人员进行测试时是无法修改代码的，所以无法直接修改Cron表达式来测试。有以下几种推荐的方法：

1. 把定时任务逻辑拆成“触发器”和“业务逻辑”
	做法：
	- 把发送消息的核心逻辑单独封装成一个方法，例如 `sendMessagesToAllUsers()`。
	- 定时任务的方法里只是调用这个方法。
	- 这样测试时，就可以直接单元测试 `sendMessagesToAllUsers()`，而不依赖时间触发。
	好处：逻辑和调度解耦，测试不需要等时间。


2. 模拟时间（Mock 时间）
    - 适合：需要验证“到 15 日 7 点才触发”这种时间条件。
    - 做法：
	    - 使用**时间虚拟化库**（例如 Java 的 `Clock` 类、Joda-Time 的 `DateTimeUtils` 或者测试框架里的 `Mockito` 对 `LocalDateTime.now()` 进行 mock）。
	    - 在测试时，把“当前时间”模拟成 15 日 7:00，让你的代码以为它到了指定时间。
	- 好处：不改 cron，也能测试时间条件。
	- 缺点：较为复杂。


3. 用xxl-job,直接在 XXL-Job 控制台手动触发
	操作步骤：
	 1. 进入XXL-Job Admin控制台。
	 2. 找到你写的这个任务（按 JobHandler 名称搜索）。
	 3. 点击 **“执行一次”**（立即执行按钮）。
	 4. 观察执行日志（可以看日志输出，也能验证消息是否正常发送）。
	好处：
	- 不改代码、不改 cron。
	- 可以随时验证生产或测试环境的任务。
	- 能配合不同参数测试，比如发送给指定测试用户，而不是全量用户。
	注意：
	- 如果消息发送会影响真实用户，测试前最好在任务参数里加标志位（比如 `isTest=true`）让代码只发给测试账号。
### 总结

- **普通定时任务**：你自己在服务里写一个闹钟，服务启动后它就一直按时间跑。
- **xxl-job**：多台机器、多个服务的“中央闹钟管理器”，它负责全局定时、统一触发、监控执行结果，让你不用在每个服务里手动写定时器。
- **如何测试**：逻辑和调度解耦拆分、模拟时间、使用xxl-job Admin直接点击来触发。